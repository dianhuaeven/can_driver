name: CI (ROS Noetic, single package repo)

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    container:
      image: osrf/ros:noetic-desktop-full
    env:
      CATKIN_WS: /root/catkin_ws
      PKG_NAME: can_driver   # 如果仓库不是 can_driver，请改为你的包名
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        shell: bash
        run: |
          set -eux
          apt-get update
          apt-get install -y --no-install-recommends \
            build-essential cmake python3-rosdep \
            ros-noetic-catkin ros-noetic-rostest ros-noetic-socketcan-interface
          rm -rf /var/lib/apt/lists/*

      - name: Setup catkin workspace and place package
        shell: bash
        run: |
          set -eux
          mkdir -p "$CATKIN_WS/src/$PKG_NAME"
          # 将当前仓库（单包）放入工作区 src/$PKG_NAME，使用 cp -a 以避免 rsync 依赖
          shopt -s dotglob
          cp -a ./* "$CATKIN_WS/src/$PKG_NAME/"
          # 初始化 rosdep
          source /opt/ros/noetic/setup.bash
          rosdep init || true
          rosdep update
          rosdep install --from-paths "$CATKIN_WS/src" --ignore-src -r -y

      - name: Build
        shell: bash
        run: |
          set -eux
          source /opt/ros/noetic/setup.bash
          cd "$CATKIN_WS"
          catkin_make -DCATKIN_ENABLE_TESTING=ON

      - name: Run tests
        shell: bash
        run: |
          set -eux
          source /opt/ros/noetic/setup.bash
          cd "$CATKIN_WS"
          catkin_make run_tests_${PKG_NAME} -j2

      - name: Collect results
        shell: bash
        run: |
          set -eux
          source /opt/ros/noetic/setup.bash
          cd "$CATKIN_WS"
          # 汇总所有测试结果，确保失败时输出日志
          catkin_test_results build || (cat build/*/test_results/*/*.xml || true; false)